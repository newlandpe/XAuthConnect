<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Login Required</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" />
</head>
<body class="ui basic segment" style="background-color: #f4f4f4;">

    <main id="main-content" class="ui middle aligned center aligned grid" style="height: 100vh; margin: 0;">
        <div class="column" style="max-width: 400px; padding: 0 1em;">
            <div id="login-container">
                <div class="ui fluid card">
                    <div class="content">
                        <h1 class="ui center aligned header">
                            Authorize "{{client_name}}"
                        </h1>
                        <p class="ui center aligned sub header">Please log in to your server account to continue.</p>
                        
                        {{error_message}}

                        <form id="login-form" class="ui form" action="/xauth/login" method="post">
                            {{oauth_params}}
                            <div class="field" id="username-field">
                                <label for="username">Username</label>
                                <input type="text" id="username" name="username" placeholder="Username" required>
                            </div>
                            <div class="field" id="password-field">
                                <label for="password">Password</label>
                                <input type="password" id="password" name="password" placeholder="Password" required>
                            </div>
                            <button id="login-button" class="ui primary fluid large button" type="submit">
                                <i class="sign in icon"></i>
                                Sign in & Authorize
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
    
    <script>
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const usernameField = document.getElementById('username-field');
        const passwordField = document.getElementById('password-field');
        
        // Функція для відновлення стану форми
        function resetFormState() {
            loginButton.classList.remove('loading', 'disabled');
            loginForm.classList.remove('disabled');
        }

        document.getElementById('login-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            // 1. Додаємо класи Semantic UI для активації лоадера на кнопці та вимкнення форми
            loginButton.classList.add('loading', 'disabled');
            loginForm.classList.add('disabled'); // Вимикаємо форму, щоб запобігти повторному надсиланню
            
            const formData = new URLSearchParams(new FormData(this));

            fetch('/xauth/login', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.request_id) {
                    connectWithSSE(data.request_id);
                } else {
                    // Якщо немає request_id (наприклад, помилка валідації на сервері), відновлюємо стан кнопки
                    resetFormState(); 
                    // Reload the page with an error
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('error', 'login_failed');
                    window.location.href = currentUrl.href;
                }
            })
            .catch(error => {
                console.error('Login request failed:', error);
                resetFormState(); // Відновлюємо стан у разі помилки мережі
                alert('An error occurred during login. Please try again.');
            });
        });

        function connectWithSSE(requestId) {
            const eventSource = new EventSource(`/xauth/login-events?request_id=${requestId}`);

            eventSource.addEventListener('login_result', function(event) {
                const data = JSON.parse(event.data);
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    resetFormState();
                    alert('Login process did not complete successfully. Please try again.');
                }
                eventSource.close();
            });

            eventSource.addEventListener('login_timeout', function(event) {
                console.error('Login timed out.');
                resetFormState();
                alert('Login timed out. Please try again.');
                eventSource.close();
            });

            eventSource.onerror = function(error) {
                console.error('EventSource failed:', error);
                resetFormState();
                alert('An error occurred while connecting to the server. Please try again.');
                eventSource.close();
            };
        }
    </script>

</body>
</html>
